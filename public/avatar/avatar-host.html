<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nyx Avatar Host</title>

  <!-- your existing skin -->
  <link rel="stylesheet" href="./avatar.css?v=9101" />

  <style>
    html,body{height:100%}
    body{margin:0;background:#000;overflow:hidden}

    /* ===== HERO STAGE (CRITICAL FIX) ===== */
    :root{
      --nyx-hero-url: none;                 /* set by NYX_CONFIG heroSrc */
      --nyx-hero-pos-y: 62%;                /* move hero DOWN so head isn't clipped */
      --nyx-hero-dim: .55;                  /* soften for readability */
    }

    #nyxStage{
      position:absolute;
      inset:0;
      background-color:#000;
      background-image: var(--nyx-hero-url);
      background-size: cover;
      background-repeat:no-repeat;
      background-position: center var(--nyx-hero-pos-y);
      transition: background-position .25s ease;
    }

    /* subtle vignette/contrast so bubble text stays legible */
    #nyxStage::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(120% 90% at 50% 20%, rgba(0,0,0,0) 30%, rgba(0,0,0,.55) 78%),
        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.70));
      opacity: var(--nyx-hero-dim);
      pointer-events:none;
    }

    /* ===== Overlay UI ===== */
    #nyxOverlay{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      padding:16px;
      pointer-events:none; /* only UI elements opt-in */
      z-index:10;
    }

    /* Everything interactive must opt back in */
    .bubble, .bubble * { pointer-events:auto; }

    .bubble{
      max-width: 100%;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      padding:14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
    }

    .bubble-text{
      color:rgba(255,255,255,.90);
      font:16px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    .bubble-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    .action-pill{
      font:12px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.28);
      color: rgba(255,255,255,.86);
      cursor:pointer;
      user-select:none;
    }

    .nyx-controls{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:10px;
    }

    .nyx-mini{
      font:12px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.28);
      color: rgba(255,255,255,.88);
      cursor:pointer;
      user-select:none;
    }
    .nyx-mini[aria-pressed="true"]{
      border-color: rgba(70,200,140,.35);
      box-shadow: 0 0 0 2px rgba(70,200,140,.10) inset;
    }

    .nyx-row{
      display:flex;
      gap:10px;
      margin-top:12px;
      align-items:stretch;
    }
    #nyxInput{
      flex:1;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      color:rgba(255,255,255,.90);
      padding:12px 14px;
      outline:none;
      min-width:0;
    }
    #nyxSend{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.08);
      color:#fff;
      padding:12px 16px;
      cursor:pointer;
      white-space:nowrap;
    }

    #nyxDiag{
      margin-top:8px;
      font:12px ui-monospace,Menlo,Consolas,monospace;
      color:rgba(255,255,255,.55);
    }
  </style>
</head>

<body>
  <div id="nyxStage" aria-hidden="true"></div>

  <div id="nyxOverlay">
    <div class="bubble" id="nyxBubble">
      <div class="bubble-text" id="nyxBubbleText">Hi‚Ä¶ I‚Äôm Nyx. How are you today?</div>

      <div class="bubble-actions" id="nyxBubbleActions">
        <div class="action-pill" data-chip="general">General</div>
        <div class="action-pill" data-chip="music">Music</div>
        <div class="action-pill" data-chip="roku">Roku</div>
        <div class="action-pill" data-chip="schedule">Schedule‚Üó</div>
        <div class="action-pill" data-chip="radio">Radio</div>
        <div class="action-pill" data-chip="news-canada">News Canada‚Üó</div>
      </div>

      <div class="nyx-controls">
        <button class="nyx-mini" id="nyxMic" type="button" title="Speech to text">üéôÔ∏è</button>
        <button class="nyx-mini" id="nyxVoiceToggle" type="button" aria-pressed="true" title="Toggle voice">üîä Voice</button>
      </div>

      <div class="nyx-row">
        <input id="nyxInput" type="text" placeholder="Type a message‚Ä¶" />
        <button id="nyxSend" type="button">Send</button>
      </div>

      <div id="nyxDiag">HOST v9101 ‚Ä¢ waiting config‚Ä¶</div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  // -------------------------
  // Config received from parent widget
  // -------------------------
  var cfg = {
    apiBase: "",
    token: "",
    tokenHeader: "X-SB-WIDGET-TOKEN",
    urls: {},
    heroSrc: ""
  };

  var mode = "general";
  var voiceEnabled = true;

  // -------------------------
  // Elements
  // -------------------------
  var stage = document.getElementById("nyxStage");
  var bubbleText = document.getElementById("nyxBubbleText");
  var actions = document.getElementById("nyxBubbleActions");
  var input = document.getElementById("nyxInput");
  var sendBtn = document.getElementById("nyxSend");
  var micBtn = document.getElementById("nyxMic");
  var voiceBtn = document.getElementById("nyxVoiceToggle");
  var diag = document.getElementById("nyxDiag");

  function safeStr(x){ return (x===null||x===undefined) ? "" : String(x); }
  function setDiag(t){ if (diag) diag.textContent = t; }
  function setBubble(t){ if (bubbleText) bubbleText.textContent = t; }

  function post(type, payload){
    try{ window.parent && window.parent.postMessage({ type:type, payload:payload||{} }, "*"); }catch(_){}
  }

  function normalizeApiBase(s){ return safeStr(s).trim().replace(/\/+$/,""); }

  function normalizeHeroSrc(src){
    src = safeStr(src).trim();
    if(!src) return "";
    if (/^file:\/\//i.test(src)) return "";
    if (/^https?:\/\//i.test(src)) return src;
    if (src[0] !== "/") src = "/" + src;
    return src;
  }

  function applyHero(heroSrc){
    heroSrc = normalizeHeroSrc(heroSrc);
    cfg.heroSrc = heroSrc;
    if (!heroSrc || !stage) return;

    // If relative path, resolve against cfg.apiBase (so iframe can fetch it reliably)
    var url = heroSrc;
    if (!/^https?:\/\//i.test(url)) {
      if (cfg.apiBase) url = cfg.apiBase + url;
    }

    document.documentElement.style.setProperty("--nyx-hero-url", "url('" + url.replace(/'/g,"%27") + "')");

    // nudge down (head-safe) ‚Äì you can tune this later if needed
    document.documentElement.style.setProperty("--nyx-hero-pos-y", "62%");
  }

  // -------------------------
  // Parent handshake
  // -------------------------
  var nonce = Math.random().toString(16).slice(2) + Date.now().toString(16);
  post("NYX_READY", { nonce: nonce });

  window.addEventListener("message", function(ev){
    var d = ev && ev.data;
    if (!d || typeof d !== "object") return;

    if (d.type === "NYX_CONFIG" && d.payload) {
      cfg.apiBase = normalizeApiBase(d.payload.apiBase);
      cfg.token = safeStr(d.payload.token).trim();
      cfg.tokenHeader = safeStr(d.payload.tokenHeader || "X-SB-WIDGET-TOKEN").trim();
      cfg.urls = (d.payload.urls && typeof d.payload.urls === "object") ? d.payload.urls : {};
      applyHero(d.payload.heroSrc || "");

      setDiag("HOST v9101 ‚Ä¢ configured ‚Ä¢ mode=" + mode);
      post("NYX_ACK", { ok:true });
    }

    // Optional: parent can tune hero position live if you want later
    if (d.type === "NYX_HERO_TUNE" && d.payload) {
      var y = safeStr(d.payload.posY).trim();
      if (y) document.documentElement.style.setProperty("--nyx-hero-pos-y", y);
    }
  });

  // -------------------------
  // Chips behavior
  // -------------------------
  function normalizeKey(k){ return safeStr(k).toLowerCase().trim(); }

  function getUrlForChip(chip){
    chip = normalizeKey(chip);
    if (cfg.urls && cfg.urls[chip]) return safeStr(cfg.urls[chip]);
    if (chip === "newscanada" && cfg.urls["news-canada"]) return safeStr(cfg.urls["news-canada"]);
    return "";
  }

  function onChip(chip){
    chip = normalizeKey(chip);

    // navigation chips open URL via parent (parent must handle NYX_OPEN_URL)
    if (chip === "roku" || chip === "radio" || chip === "schedule" || chip === "news-canada") {
      var u = getUrlForChip(chip);
      if (u) { post("NYX_OPEN_URL", { key: chip, url: u }); return; }
      setBubble("No destination URL for ‚Äú" + chip + "‚Äù yet.");
      return;
    }

    // mode chips
    if (chip === "general" || chip === "music") {
      mode = chip;
      setBubble("Mode set: " + (mode === "music" ? "Music" : "General") + ". What do you want to do?");
      setDiag("HOST v9101 ‚Ä¢ configured ‚Ä¢ mode=" + mode);
      return;
    }

    setBubble("Chip: " + chip);
  }

  if (actions) {
    actions.addEventListener("click", function(e){
      var t = e.target;
      var el = t && t.closest ? t.closest("[data-chip]") : null;
      if (!el) return;
      var chip = el.getAttribute("data-chip");
      if (!chip) return;
      onChip(chip);
    });
  }

  // -------------------------
  // API calls
  // -------------------------
  async function apiChat(userText){
    var url = cfg.apiBase ? (cfg.apiBase + "/api/chat") : "";
    if (!url) throw new Error("missing apiBase");

    var headers = { "Content-Type":"application/json" };
    if (cfg.token) headers[cfg.tokenHeader || "X-SB-WIDGET-TOKEN"] = cfg.token;

    var res = await fetch(url, {
      method:"POST",
      headers: headers,
      body: JSON.stringify({ message: userText, mode: mode }),
      credentials:"omit"
    });

    if (!res.ok) {
      var txt = await res.text().catch(function(){ return ""; });
      throw new Error("chat http " + res.status + " " + txt.slice(0,120));
    }
    return await res.json().catch(function(){ return {}; });
  }

  async function apiTTS(text){
    if (!cfg.apiBase) throw new Error("missing apiBase");
    if (!text) return null;

    var headers = { "Content-Type":"application/json" };
    if (cfg.token) headers[cfg.tokenHeader || "X-SB-WIDGET-TOKEN"] = cfg.token;

    async function hit(path){
      var res = await fetch(cfg.apiBase + path, {
        method:"POST",
        headers: headers,
        body: JSON.stringify({ text: text }),
        credentials:"omit"
      });

      if (res.status === 204) return null; // fail-open
      if (!res.ok) return null;

      var ct = (res.headers.get("content-type") || "").toLowerCase();
      if (ct.includes("audio")) return await res.blob();

      var j = await res.json().catch(function(){ return null; });
      if (j && j.audioUrl) return j.audioUrl;
      return null;
    }

    return (await hit("/api/tts")) || (await hit("/api/voice"));
  }

  function playAudioBlob(blob){
    try{
      var u = URL.createObjectURL(blob);
      var a = new Audio(u);
      a.onended = function(){ try{ URL.revokeObjectURL(u); }catch(_){} };
      a.play().catch(function(){});
    }catch(_){}
  }

  async function sendMessage(){
    var txt = safeStr(input && input.value).trim();
    if (!txt) return;

    if (input) input.value = "";
    setBubble("‚Ä¶");
    post("NYX_PRESENCE", { presence:"thinking" });

    if (!cfg.apiBase) {
      setBubble("Not configured yet (no API base). Close/open the widget once so NYX_CONFIG arrives.");
      post("NYX_PRESENCE", { presence:"ready" });
      return;
    }

    try{
      var out = await apiChat(txt);
      var reply = safeStr(out && (out.reply || out.text || out.message || out.output)).trim()
        || "I got that. (No reply payload returned.)";

      setBubble(reply);
      post("NYX_PRESENCE", { presence:"speaking" });

      if (voiceEnabled) {
        try{
          var audio = await apiTTS(reply);
          if (audio && typeof audio === "string") {
            try{ new Audio(audio).play().catch(function(){}); }catch(_){}
          } else if (audio) {
            playAudioBlob(audio);
          }
        }catch(_){}
      }

      post("NYX_PRESENCE", { presence:"ready" });
    }catch(err){
      setBubble("Bridge error: " + safeStr(err && err.message).slice(0,180));
      post("NYX_PRESENCE", { presence:"ready" });
    }
  }

  if (sendBtn) sendBtn.addEventListener("click", sendMessage);
  if (input) {
    input.addEventListener("keydown", function(e){
      if (e.key === "Enter") { e.preventDefault(); sendMessage(); }
    });
  }

  // -------------------------
  // Speech-to-text
  // -------------------------
  var recognizer = null;

  function canSTT(){ return !!(window.SpeechRecognition || window.webkitSpeechRecognition); }

  function initSTT(){
    var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    var r = new SR();
    r.continuous = false;
    r.interimResults = false;
    r.lang = "en-US";
    r.onresult = function(ev){
      try{
        var t = ev.results && ev.results[0] && ev.results[0][0] && ev.results[0][0].transcript;
        t = safeStr(t).trim();
        if (t && input) input.value = t;
      }catch(_){}
    };
    r.onend = function(){ if (micBtn) micBtn.textContent = "üéôÔ∏è"; };
    return r;
  }

  if (micBtn) {
    if (!canSTT()) {
      micBtn.disabled = true;
      micBtn.title = "Speech-to-text not supported in this browser.";
      micBtn.style.opacity = ".55";
      micBtn.style.cursor = "not-allowed";
    } else {
      recognizer = initSTT();
      micBtn.addEventListener("click", function(){
        if (!recognizer) recognizer = initSTT();
        if (!recognizer) return;
        try{ micBtn.textContent = "‚è∫Ô∏è"; recognizer.start(); }catch(_){ micBtn.textContent = "üéôÔ∏è"; }
      });
    }
  }

  // -------------------------
  // Voice toggle
  // -------------------------
  if (voiceBtn) {
    voiceBtn.setAttribute("aria-pressed", "true");
    voiceBtn.addEventListener("click", function(){
      voiceEnabled = !voiceEnabled;
      voiceBtn.setAttribute("aria-pressed", voiceEnabled ? "true" : "false");
      voiceBtn.textContent = voiceEnabled ? "üîä Voice" : "üîá Voice";
    });
  }

})();
</script>
</body>
</html>
