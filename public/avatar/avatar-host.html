<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nyx Avatar Host</title>

<link rel="stylesheet" href="./avatar.css?v=9112" />

<style>
html,body{height:100%}
body{margin:0;background:#000;overflow:hidden}

/* ===== HERO STAGE (WIDGET-CALIBRATED) ===== */
:root{
  --nyx-hero-abs:url("https://sandblast-backend.onrender.com/avatar/assets/nyx-hero.png");
  --nyx-hero-url:var(--nyx-hero-abs);

  /* tuned for ~600px widget height */
  --nyx-hero-pos-x:50%;
  --nyx-hero-pos-y:18%;
  --nyx-hero-scale:118%;

  --nyx-hero-dim:.10;
}

#nyxStage{
  position:absolute;
  inset:0;
  background-color:#000;
  background-image:var(--nyx-hero-url);
  background-repeat:no-repeat;
  background-size:var(--nyx-hero-scale) auto;
  background-position:var(--nyx-hero-pos-x) var(--nyx-hero-pos-y);
  transition:background-position .2s ease,background-size .2s ease;
  filter:saturate(1.02);
}

#nyxStage::after{
  content:"";
  position:absolute;
  inset:0;
  pointer-events:none;
  opacity:var(--nyx-hero-dim);
  background:
    radial-gradient(120% 100% at 50% 38%, rgba(0,0,0,0) 60%, rgba(0,0,0,.45) 100%),
    linear-gradient(180deg, rgba(0,0,0,.05), rgba(0,0,0,.25));
}

/* ===== Overlay UI ===== */
#nyxOverlay{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:flex-end;
  padding:16px;
  pointer-events:none;
  z-index:10;
}

.bubble,.bubble *{pointer-events:auto}

.bubble{
  border-radius:18px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.38);
  backdrop-filter:blur(10px);
  padding:14px;
  box-shadow:0 18px 60px rgba(0,0,0,.55);
}

.bubble-text{
  color:rgba(255,255,255,.92);
  font:16px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  line-height:1.35;
  white-space:pre-wrap;
}

.bubble-actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:12px;
}

.action-pill{
  font:12px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.30);
  color:rgba(255,255,255,.88);
  cursor:pointer;
  user-select:none;
  transition:transform .08s ease, background .12s ease, border-color .12s ease;
}
.action-pill:active{ transform:scale(.98); }

.action-pill.is-active{
  border-color:rgba(255,255,255,.24);
  background:rgba(255,255,255,.10);
}

.nyx-controls{
  display:flex;
  gap:8px;
  margin-top:10px;
}

.nyx-mini{
  font:12px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.28);
  color:#fff;
  cursor:pointer;
}
.nyx-mini.is-on{
  border-color:rgba(255,255,255,.24);
  background:rgba(255,255,255,.10);
}

.nyx-row{
  display:flex;
  gap:10px;
  margin-top:12px;
}

#nyxInput{
  flex:1;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.25);
  color:#fff;
  padding:12px 14px;
  outline:none;
}

#nyxSend{
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.08);
  color:#fff;
  padding:12px 16px;
  cursor:pointer;
}

#nyxDiag{
  margin-top:8px;
  font:12px ui-monospace,Menlo,Consolas,monospace;
  color:rgba(255,255,255,.55);
}
</style>
</head>

<body>
<div id="nyxStage"></div>

<div id="nyxOverlay">
  <div class="bubble">
    <div class="bubble-text" id="nyxBubbleText">Hi‚Ä¶ I‚Äôm Nyx. How are you today?</div>

    <div class="bubble-actions" id="nyxChips">
      <div class="action-pill" data-chip="general">General</div>
      <div class="action-pill" data-chip="music">Music</div>
      <div class="action-pill" data-chip="roku">Roku</div>
      <div class="action-pill" data-chip="schedule">Schedule‚Üó</div>
      <div class="action-pill" data-chip="radio">Radio</div>
      <div class="action-pill" data-chip="news-canada">News Canada‚Üó</div>
    </div>

    <div class="nyx-controls">
      <button class="nyx-mini" id="nyxMic" type="button">üéôÔ∏è</button>
      <button class="nyx-mini" id="nyxVoiceToggle" type="button">üîä Voice</button>
    </div>

    <div class="nyx-row">
      <input id="nyxInput" type="text" placeholder="Type a message‚Ä¶" autocomplete="off" />
      <button id="nyxSend" type="button">Send</button>
    </div>

    <div id="nyxDiag">HOST v9112 ‚Ä¢ ready</div>
  </div>
</div>

<script>
(function(){
  "use strict";

  // =========================
  // Utilities
  // =========================
  function $(id){ return document.getElementById(id); }
  function safeStr(x){ return (x===null || x===undefined) ? "" : String(x); }
  function safeJsonParse(str){ try { return JSON.parse(str); } catch(e){ return null; } }
  function now(){ return Date.now(); }
  function trimSlash(s){ return String(s||"").replace(/\/+$/,""); }
  function makeId(){
    try{ if(window.crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(_){}
    return (Math.random().toString(16).slice(2) + now().toString(16)).slice(0, 24);
  }
  function getOriginFromReferrer(){
    try{
      var r = document.referrer || "";
      if(!r) return null;
      return (new URL(r)).origin;
    }catch(e){ return null; }
  }
  function parseQuery(){
    var out = {};
    try{
      var qs = new URLSearchParams(location.search || "");
      qs.forEach(function(v,k){ out[String(k||"").toLowerCase()] = String(v||""); });
    }catch(_){}
    return out;
  }

  var diagEl = $("nyxDiag");
  function diag(msg){ if(diagEl) diagEl.textContent = msg; }

  // =========================
  // Bridge State
  // =========================
  var PARENT_ORIGIN = getOriginFromReferrer();
  var READY_ACK = false;

  var CONFIG = {
    version: "9112",
    apiBase: null,
    token: null,
    heroSrc: null,
    voiceDefaultOn: false
  };

  // Local UI State
  var UI_STATE = {
    lane: "general",
    chip: "general",
    voiceOn: false,
    sttOn: false,
    pending: false,
    lastRequestId: null
  };

  // =========================
  // Token persistence
  // =========================
  var LS_TOKEN_KEY = "nyx_api_token_v1";
  var LS_API_KEY   = "nyx_api_base_v1";

  function loadPersisted(){
    try{
      var t = localStorage.getItem(LS_TOKEN_KEY);
      if(t && !CONFIG.token) CONFIG.token = String(t).trim();
    }catch(_){}
    try{
      var a = localStorage.getItem(LS_API_KEY);
      if(a && !CONFIG.apiBase) CONFIG.apiBase = String(a).trim();
    }catch(_){}
  }
  function persistToken(tok){
    try{
      localStorage.setItem(LS_TOKEN_KEY, String(tok||"").trim());
    }catch(_){}
  }
  function persistApiBase(base){
    try{
      localStorage.setItem(LS_API_KEY, String(base||"").trim());
    }catch(_){}
  }

  // =========================
  // Parent messaging
  // =========================
  function postToParent(payload){
    if(!window.parent || window.parent === window) return false;
    try{
      window.parent.postMessage(payload, PARENT_ORIGIN || "*");
      return true;
    }catch(e){ return false; }
  }

  function sendReady(){
    postToParent({ type:"NYX_READY", v: CONFIG.version, ts: now() });
  }

  // =========================
  // Bootstrap from query + localStorage
  // =========================
  (function bootstrap(){
    loadPersisted();

    var q = parseQuery();

    // api base
    var api = q.api || q.apibase || q.base || "";
    if(api) CONFIG.apiBase = api;

    // token
    var tok = q.token || q.t || "";
    if(tok) CONFIG.token = tok;

    // hero
    var hero = q.hero || q.herosrc || "";
    if(hero) CONFIG.heroSrc = hero;

    // voice default
    var voice = (q.voice || "").toLowerCase();
    if(voice === "1" || voice === "true") CONFIG.voiceDefaultOn = true;

    if(CONFIG.apiBase) persistApiBase(CONFIG.apiBase);
    if(CONFIG.token) persistToken(CONFIG.token);

    if(CONFIG.heroSrc){
      document.documentElement.style.setProperty("--nyx-hero-abs", 'url("' + CONFIG.heroSrc + '")');
      document.documentElement.style.setProperty("--nyx-hero-url", 'var(--nyx-hero-abs)');
    }
  })();

  // READY retry to beat race conditions
  sendReady();
  var tries = 0;
  var maxTries = 12;
  var timer = setInterval(function(){
    tries++;
    if(READY_ACK || tries > maxTries){ clearInterval(timer); return; }
    sendReady();
  }, 250);

  // Ask parent for config (safe if ignored)
  postToParent({ type:"NYX_NEED_CONFIG", v: CONFIG.version, ts: now() });

  // =========================
  // Inbound messages
  // =========================
  window.addEventListener("message", function(ev){
    try{
      if(PARENT_ORIGIN && ev.origin !== PARENT_ORIGIN) return;

      var data = ev.data;
      if(typeof data === "string"){
        var parsed = safeJsonParse(data);
        if(parsed) data = parsed;
      }
      if(!data || typeof data !== "object") return;

      var t = data.type;

      if(t === "NYX_READY_ACK"){
        READY_ACK = true;
        diag("HOST v9112 ‚Ä¢ ready (ack)");
        return;
      }

      if(t === "NYX_CONFIG"){
        var c = (data.config && typeof data.config === "object") ? data.config : {};
        if(typeof c.apiBase === "string") CONFIG.apiBase = c.apiBase;
        if(typeof c.token === "string") CONFIG.token = c.token;
        if(typeof c.heroSrc === "string") CONFIG.heroSrc = c.heroSrc;
        if(typeof c.voiceDefaultOn === "boolean") CONFIG.voiceDefaultOn = c.voiceDefaultOn;

        if(CONFIG.apiBase) persistApiBase(CONFIG.apiBase);
        if(CONFIG.token) persistToken(CONFIG.token);

        if(CONFIG.heroSrc){
          document.documentElement.style.setProperty("--nyx-hero-abs", 'url("' + CONFIG.heroSrc + '")');
          document.documentElement.style.setProperty("--nyx-hero-url", 'var(--nyx-hero-abs)');
        }

        if(CONFIG.voiceDefaultOn) setVoice(true);

        diag("HOST v9112 ‚Ä¢ config loaded" + (CONFIG.token ? " (token)" : " (no token)"));
        postToParent({ type:"NYX_CONFIG_ACK", v: CONFIG.version, ts: now() });
        return;
      }

      if(t === "NYX_PING"){
        postToParent({ type:"NYX_PONG", v: CONFIG.version, ts: now() });
        return;
      }

      if(t === "NYX_SET_BUBBLE" && typeof data.text === "string"){
        setBubbleText(data.text);
        return;
      }
    }catch(_){}
  });

  // =========================
  // Backend client
  // =========================
  function apiBase(){
    return (CONFIG.apiBase && String(CONFIG.apiBase).trim())
      ? String(CONFIG.apiBase).trim()
      : location.origin;
  }

  function authHeaders(headers){
    if(CONFIG.token){
      headers["Authorization"] = "Bearer " + CONFIG.token;
      headers["X-API-Token"] = CONFIG.token;
    }
    return headers;
  }

  async function postJson(url, payload){
    var headers = authHeaders({ "Content-Type":"application/json" });
    headers["X-Client-Source"] = "nyx_host_iframe";
    headers["X-Route-Hint"] = safeStr(payload && payload.routeHint ? payload.routeHint : UI_STATE.lane);

    var r, txt, json;
    try{
      r = await fetch(url, {
        method: "POST",
        headers: headers,
        body: JSON.stringify(payload),
        credentials: "include"
      });
    }catch(e){
      return { ok:false, error:"network_error", status:0, detail:safeStr(e && e.message) };
    }

    try{ txt = await r.text(); }catch(_){ txt = ""; }
    json = safeJsonParse(txt);
    if(!json){
      return { ok:false, error:"bad_json", status:r.status, raw: (txt || "").slice(0, 600) };
    }
    json.__httpStatus = r.status;
    return json;
  }

  // =========================
  // Intent packet builder
  // =========================
  function laneFromChip(chip){
    chip = safeStr(chip).toLowerCase();
    if(chip === "music") return "music";
    if(chip === "roku") return "roku";
    if(chip === "radio") return "radio";
    if(chip === "general") return "general";
    return "general";
  }

  function buildIntentPacket(opts){
    opts = (opts && typeof opts === "object") ? opts : {};
    var text = safeStr(opts.text).trim();
    var chip = safeStr(opts.chip || UI_STATE.chip || "general").trim();
    var lane = safeStr(opts.lane || UI_STATE.lane || "general").trim();
    var action = safeStr(opts.action || "").trim();
    var intent = safeStr(opts.intent || "").trim();
    var route = safeStr(opts.route || "").trim();
    var label = safeStr(opts.label || "").trim();

    if(!text && !action){
      action = "chip";
      intent = intent || "select";
      route = route || lane;
      label = label || chip;
    }

    var requestId = makeId();

    return {
      requestId: requestId,
      text: text,
      payload: {
        lane: lane,
        action: action || undefined,
        intent: intent || undefined,
        route: route || undefined,
        label: label || undefined,
        chip: chip || undefined
      },
      client: {
        source: "nyx_host_iframe",
        routeHint: lane,
        chip: chip
      }
    };
  }

  // =========================
  // Bubble + Voice
  // =========================
  var bubbleEl = $("nyxBubbleText");
  function setBubbleText(t){
    if(bubbleEl) bubbleEl.textContent = safeStr(t || "");
  }

  var voiceBtn = $("nyxVoiceToggle");
  function setVoice(on){
    UI_STATE.voiceOn = !!on;
    if(voiceBtn){
      if(UI_STATE.voiceOn) voiceBtn.classList.add("is-on");
      else voiceBtn.classList.remove("is-on");
    }
  }

  function stopAudio(){
    try{
      if(window.__NYX_AUDIO && typeof window.__NYX_AUDIO.pause === "function"){
        window.__NYX_AUDIO.pause();
        window.__NYX_AUDIO.currentTime = 0;
      }
    }catch(_){}
  }

  async function speak(text){
    if(!UI_STATE.voiceOn) return;
    var s = safeStr(text).trim();
    if(!s) return;

    stopAudio();

    try{
      var url = trimSlash(apiBase()) + "/api/tts";
      var headers = authHeaders({ "Content-Type":"application/json" });

      var r = await fetch(url, {
        method: "POST",
        headers: headers,
        body: JSON.stringify({ text: s }),
        credentials: "include"
      });

      if(!r.ok) return;

      var buf = await r.arrayBuffer();
      var blob = new Blob([buf], { type: "audio/mpeg" });
      var objUrl = URL.createObjectURL(blob);

      var a = new Audio(objUrl);
      window.__NYX_AUDIO = a;
      a.onended = function(){ try{ URL.revokeObjectURL(objUrl); }catch(_){ } };
      a.play().catch(function(){});
    }catch(_){}
  }

  // =========================
  // Token recovery on 401
  // =========================
  function promptForToken(){
    try{
      var current = CONFIG.token ? "(already set)" : "";
      var tok = window.prompt("Nyx needs an API token (401). Paste token here:", "");
      tok = (tok || "").trim();
      if(tok){
        CONFIG.token = tok;
        persistToken(tok);
        diag("HOST v9112 ‚Ä¢ token saved");
        return true;
      }
    }catch(_){}
    return false;
  }

  // =========================
  // Core send pipeline
  // =========================
  var input = $("nyxInput");
  var sendBtn = $("nyxSend");
  var chips = $("nyxChips");

  function setPending(on){
    UI_STATE.pending = !!on;
    if(sendBtn) sendBtn.disabled = UI_STATE.pending;
    if(input) input.disabled = UI_STATE.pending;
  }

  async function sendPacket(packet, didRetry){
    UI_STATE.lastRequestId = safeStr(packet && packet.requestId);
    setPending(true);

    diag("HOST v9112 ‚Ä¢ sending‚Ä¶" + (CONFIG.token ? "" : " (no token)"));
    postToParent({ type:"NYX_OUTBOUND", v:CONFIG.version, ts:now(), packet: packet });

    var url = trimSlash(apiBase()) + "/api/chat";
    var out = await postJson(url, packet);
    var status = Number(out && out.__httpStatus) || Number(out && out.status) || 0;

    if(status === 401 && !didRetry){
      // Ask once for token, save, retry same packet
      setPending(false);
      setBubbleText("Auth required (401). Setting token now‚Ä¶");
      diag("HOST v9112 ‚Ä¢ 401 auth required");
      if(promptForToken()){
        return sendPacket(packet, true);
      }
      setBubbleText("Auth required (401). Token not provided.");
      diag("HOST v9112 ‚Ä¢ 401 (no token provided)");
      return out;
    }

    if(out && out.reply){
      setBubbleText(out.reply);
      speak(out.reply);
      postToParent({ type:"NYX_REPLY", v:CONFIG.version, ts:now(), reply: out.reply, meta: out.meta || {} });
      diag("HOST v9112 ‚Ä¢ ok");
    }else{
      if(status === 401){
        setBubbleText("Auth required (401). Token is missing/invalid.");
        diag("HOST v9112 ‚Ä¢ error 401");
      }else if(status === 403){
        setBubbleText("Blocked (403). Token/CORS policy mismatch.");
        diag("HOST v9112 ‚Ä¢ error 403");
      }else if(status === 0){
        setBubbleText("Network error. Backend unreachable or blocked.");
        diag("HOST v9112 ‚Ä¢ network error");
      }else{
        setBubbleText("Hmm. I didn‚Äôt get a clean reply. Try again.");
        diag("HOST v9112 ‚Ä¢ error " + safeStr(status));
      }

      var msg = (out && (out.error || out.detail))
        ? (safeStr(out.error) + (out.detail ? (": "+safeStr(out.detail)) : ""))
        : "No reply.";

      postToParent({ type:"NYX_ERROR", v:CONFIG.version, ts:now(), error: msg, raw: out });
    }

    setPending(false);
    return out;
  }

  function sendTypedText(){
    var text = (input && input.value) ? String(input.value).trim() : "";
    if(!text) return;
    var packet = buildIntentPacket({
      text: text,
      chip: UI_STATE.chip,
      lane: UI_STATE.lane,
      action: "user_text",
      intent: "message",
      route: UI_STATE.lane,
      label: UI_STATE.chip
    });
    if(input) input.value = "";
    return sendPacket(packet, false);
  }

  // =========================
  // Chip handling
  // =========================
  function setActiveChip(chip){
    UI_STATE.chip = chip;
    UI_STATE.lane = laneFromChip(chip);

    if(chips){
      var pills = chips.querySelectorAll(".action-pill");
      for(var i=0;i<pills.length;i++){
        var p = pills[i];
        var c = p.getAttribute("data-chip");
        if(c === chip) p.classList.add("is-active");
        else p.classList.remove("is-active");
      }
    }
  }

  function openLinkForChip(chip){
    postToParent({ type:"NYX_NAV", where: chip, ts: now() });
  }

  function handleChipClick(chip){
    chip = safeStr(chip).trim();
    if(!chip) return;

    if(chip === "schedule" || chip === "news-canada"){
      openLinkForChip(chip);
      return;
    }

    setActiveChip(chip);

    var packet = buildIntentPacket({
      text: "",
      chip: chip,
      lane: UI_STATE.lane,
      action: "chip",
      intent: "select",
      route: UI_STATE.lane,
      label: chip
    });

    postToParent({ type:"NYX_CHIP", v:CONFIG.version, ts:now(), chip: chip, lane: UI_STATE.lane });
    return sendPacket(packet, false);
  }

  if(sendBtn){
    sendBtn.addEventListener("click", function(){ try{ sendTypedText(); }catch(_){ } });
  }
  if(input){
    input.addEventListener("keydown", function(e){
      try{
        if(e.key === "Enter"){
          e.preventDefault();
          sendTypedText();
        }
      }catch(_){}
    });
  }
  if(chips){
    chips.addEventListener("click", function(e){
      try{
        var t = e.target;
        while(t && t !== chips && !(t.classList && t.classList.contains("action-pill"))){
          t = t.parentNode;
        }
        if(!t || t === chips) return;
        var chip = t.getAttribute("data-chip");
        if(chip) handleChipClick(chip);
      }catch(_){}
    });
  }

  // Default chip state
  setActiveChip("general");

  // =========================
  // STT
  // =========================
  var micBtn = $("nyxMic");
  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
  var rec = null;

  function setMic(on){
    UI_STATE.sttOn = !!on;
    if(micBtn){
      if(UI_STATE.sttOn) micBtn.classList.add("is-on");
      else micBtn.classList.remove("is-on");
    }
  }

  function stopSTT(){
    try{
      if(rec){
        rec.onresult = null;
        rec.onerror = null;
        rec.onend = null;
        rec.stop();
      }
    }catch(_){}
    setMic(false);
  }

  function startSTT(){
    if(!SpeechRecognition){
      diag("HOST v9112 ‚Ä¢ STT unsupported");
      return;
    }
    if(UI_STATE.pending) return;

    if(!rec){
      rec = new SpeechRecognition();
      rec.continuous = false;
      rec.interimResults = false;
      rec.lang = "en-US";
    }

    rec.onresult = function(ev){
      try{
        var t = "";
        if(ev && ev.results && ev.results[0] && ev.results[0][0]){
          t = safeStr(ev.results[0][0].transcript).trim();
        }
        if(t){
          if(input) input.value = t;
          sendTypedText();
        }
      }catch(_){}
    };

    rec.onerror = function(){ stopSTT(); diag("HOST v9112 ‚Ä¢ STT error"); };
    rec.onend = function(){ setMic(false); };

    try{ rec.start(); setMic(true); diag("HOST v9112 ‚Ä¢ listening‚Ä¶"); }catch(_){ setMic(false); }
  }

  if(micBtn){
    micBtn.addEventListener("click", function(){
      try{
        if(UI_STATE.sttOn) stopSTT();
        else startSTT();
        postToParent({ type:"NYX_MIC_TOGGLE", v:CONFIG.version, ts:now(), on: UI_STATE.sttOn });
      }catch(_){}
    });
  }

  // =========================
  // Voice toggle
  // =========================
  var voiceBtn = $("nyxVoiceToggle");
  if(voiceBtn){
    voiceBtn.addEventListener("click", function(){
      try{
        setVoice(!UI_STATE.voiceOn);
        if(!UI_STATE.voiceOn) stopAudio();
        postToParent({ type:"NYX_VOICE_TOGGLE", v:CONFIG.version, ts:now(), on: UI_STATE.voiceOn });
      }catch(_){}
    });
  }

  if(CONFIG.voiceDefaultOn) setVoice(true);

  // Boot diag shows if token is present
  diag("HOST v9112 ‚Ä¢ ready" + (CONFIG.token ? " (token)" : " (no token)"));

})();
</script>

</body>
</html>
