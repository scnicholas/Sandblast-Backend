<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Nyx Avatar Host (Phase 1 Clean)</title>

<!-- Skin -->
<link rel="stylesheet" href="./avatar.css?v=PHASE1_CLEAN_9204d" />

<script>
/* ============================================================
   NYX PHASE 1 — CLEAN HOST (NO LEGACY UI)
   - Forces Phase 1 renderer only
   - Blocks legacy widget injection
   - Provides a minimal, hardened chat client (configurable endpoint)
============================================================ */
window.NYX_HOST_PHASE1 = true;
window.NYX_DISABLE_LEGACY = true;
window.NYX_HOST_MODE = "phase1_clean";
</script>

<style>
  html,body{height:100%}
  body{margin:0;background:#000;overflow:hidden}

  /* ============================================================
     HARD FENCE: if anything legacy appears, hide it
     (keeps this host visually clean even if old bundles try to mount)
  ============================================================ */
  body.nyx-phase1 #wrap,
  body.nyx-phase1 #avatarRoot,
  body.nyx-phase1 #panel,
  body.nyx-phase1 #nyxOverlay,
  body.nyx-phase1 #nyxInputDock,
  body.nyx-phase1 #sbnyx-host,
  body.nyx-phase1 #sbnyx-launcher,
  body.nyx-phase1 #nyxLauncher,
  body.nyx-phase1 #nyx-host,
  body.nyx-phase1 .sbnyx-launcher,
  body.nyx-phase1 .sbnyx-host,
  body.nyx-phase1 .nyx-mic-puck,
  body.nyx-phase1 .mic-puck,
  body.nyx-phase1 .floating-mic,
  body.nyx-phase1 .micOrb,
  body.nyx-phase1 #micOrb,
  body.nyx-phase1 #nyxMicOrb,
  body.nyx-phase1 .sbnyx-close,
  body.nyx-phase1 #sbnyxClose,
  body.nyx-phase1 .nyx-legacy-close,
  body.nyx-phase1 #nyxLegacyClose{
    display:none !important;
  }

  /* ============================================================
     Host layout (fallback if avatar.css missing)
  ============================================================ */
  #nyxApp{
    height:100vh;
    display:grid;
    grid-template-columns: minmax(0,1fr) 380px;
    gap:12px;
    padding:12px;
    box-sizing:border-box;
  }

  #nyxHero{
    position:relative;
    border-radius:22px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.08);
    background:#000;
    isolation:isolate;
    min-height:520px;
  }

  /* Video-first stage */
  #nyxStage{ position:absolute; inset:0; background:#000; overflow:hidden; z-index:1; }
  #nyxHeroVideo{
    position:absolute; inset:0;
    width:100%; height:100%;
    object-fit:cover;
    object-position: var(--nyx-hero-pos-x,50%) var(--nyx-hero-pos-y,12%);
    transform: scale(var(--nyx-hero-scale-num,1.22));
    transform-origin: var(--nyx-hero-pos-x,50%) var(--nyx-hero-pos-y,12%);
    filter:saturate(1.04) contrast(1.02);
    pointer-events:none;
  }
  #nyxStage.is-image{
    background-repeat:no-repeat;
    background-size: 132% auto;
    background-position: var(--nyx-hero-pos-x,50%) var(--nyx-hero-pos-y,12%);
  }
  #nyxStage.is-image #nyxHeroVideo{ display:none; }
  #nyxStage::after{
    content:"";
    position:absolute; inset:0;
    pointer-events:none;
    opacity: var(--nyx-hero-dim,.12);
    background:
      radial-gradient(120% 100% at 52% 34%, rgba(0,0,0,0) 58%, rgba(0,0,0,.48) 100%),
      linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,.30));
    z-index:2;
  }

  /* Sacred shoulder bubble (short + clamped) */
  #nyxBubble{
    position:absolute;
    left:18px; right:18px; bottom:18px;
    z-index:5;
    max-width: 92%;
    max-height: min(32vh, 280px);
    overflow:hidden;
    border-radius:20px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(18,18,22,.62);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 16px 50px rgba(0,0,0,.55);
  }
  #nyxBubbleText{
    padding:14px 16px 12px 16px;
    color: rgba(255,255,255,.96);
    font: 500 15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    max-height: min(20vh, 180px);
    overflow:auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Top controls in hero */
  #nyxTopControls{
    position:absolute;
    top:12px; right:12px;
    z-index:6;
    display:flex; gap:8px;
    pointer-events:auto;
  }
  .nyx-mini{
    font:12px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    padding:8px 10px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(18,18,22,.55);
    color: rgba(255,255,255,.92);
    cursor:pointer;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .nyx-mini:focus{ outline:2px solid rgba(140,0,35,.35); outline-offset:2px; }

  /* Dock */
  #nyxDock{
    position:relative;
    border-radius:22px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,.08);
    background: rgba(12,12,16,.78);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 22px 80px rgba(0,0,0,.72);
    display:flex;
    flex-direction:column;
    min-height:520px;
    min-width:0;
  }
  #nyxDockHeader{
    padding:12px;
    border-bottom:1px solid rgba(255,255,255,.08);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  #nyxTitle{
    display:flex; align-items:center; gap:10px;
    font: 650 14px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color: rgba(255,255,255,.92);
    user-select:none;
  }
  #nyxDot{ width:9px; height:9px; border-radius:999px; background: rgba(140,0,35,.92); box-shadow:0 0 14px rgba(140,0,35,.45); }
  #nyxMarion{
    display:inline-flex; align-items:center; justify-content:center;
    width:18px; height:18px; border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.18);
    color: rgba(255,255,255,.72);
    font: 700 11px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  #nyxMarion.on{
    background: rgba(140,0,35,.16);
    border-color: rgba(140,0,35,.55);
    color: rgba(255,255,255,.90);
    box-shadow: 0 0 16px rgba(140,0,35,.25);
  }

  #nyxDockControls{ display:flex; gap:8px; align-items:center; }
  .nyx-btn{
    font:12px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    padding:8px 10px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.18);
    color: rgba(255,255,255,.88);
    cursor:pointer;
    user-select:none;
    white-space:nowrap;
  }
  .nyx-btn:focus{ outline:2px solid rgba(140,0,35,.35); outline-offset:2px; }
  .nyx-btn.is-on{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.22); }

  /* Chips rail (fixed row) */
  #nyxChips{
    display:flex;
    gap:10px;
    padding:10px 12px;
    border-bottom:1px solid rgba(255,255,255,.06);
    overflow-x:auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  #nyxChips::-webkit-scrollbar{ display:none; }
  .chip{
    flex:0 0 auto;
    font: 12.2px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    padding:8px 11px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: rgba(255,255,255,.90);
    cursor:pointer;
    user-select:none;
    white-space:nowrap;
  }
  .chip:hover{ background: rgba(140,0,35,.14); border-color: rgba(140,0,35,.55); }
  .chip.is-active{ background: rgba(140,0,35,.22); border-color: rgba(140,0,35,.60); }

  /* Scroll-contained viewport (CRITICAL: min-height:0 keeps footer visible) */
  #nyxScroll{
    flex: 1 1 auto;
    min-height: 0;
    overflow:auto;
    padding:12px;
    padding-bottom: 14px;
  }
  #nyxMsgs{ display:flex; flex-direction:column; gap:10px; }
  .nyx-msg{
    max-width: 92%;
    padding:10px 12px;
    border-radius: 16px;
    border:1px solid rgba(255,255,255,.08);
    background: rgba(0,0,0,.26);
    color: rgba(255,255,255,.92);
    font: 13.5px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    white-space: pre-wrap;
  }
  .nyx-msg.me{
    margin-left:auto;
    background: rgba(140,0,35,.22);
    border-color: rgba(140,0,35,.34);
  }

  /* Empty state */
  #nyxEmpty{
    display:none;
    padding:14px 12px;
    border-radius: 16px;
    border:1px dashed rgba(255,255,255,.16);
    background: rgba(255,255,255,.04);
    color: rgba(255,255,255,.74);
    font: 13px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  #nyxDock.is-empty #nyxEmpty{ display:block; }
  #nyxDock.is-empty #nyxMsgs{ display:none; }

  /* Input row (CRITICAL: inside dock, always visible) */
  #nyxInputRow{
    display:flex;
    gap:8px;
    padding:12px;
    border-top: 1px solid rgba(255,255,255,.08);
    background: rgba(0,0,0,.20);
    padding-bottom: calc(12px + env(safe-area-inset-bottom,0px));
  }
  #nyxInput{
    flex:1;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.35);
    color: rgba(255,255,255,.92);
    padding:10px 12px;
    outline:none;
  }
  #nyxInput:focus{ outline:2px solid rgba(140,0,35,.28); outline-offset:2px; }
  #nyxSend{
    border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(140,0,35,.85);
    color: rgba(255,255,255,.95);
    padding:10px 12px;
    cursor:pointer;
    white-space:nowrap;
  }
  #nyxSend:disabled{ opacity:.65; cursor:not-allowed; }

  /* Compact iframe mode */
  @media (max-width: 520px){
    #nyxBubble{ display:none; }
    #nyxApp{
      grid-template-columns: 1fr;
      grid-template-rows: minmax(0,1fr) auto;
      gap:10px;
      padding:10px;
    }
    #nyxHero{ min-height: 0; height: 100%; }
    #nyxDock{ min-height: 200px; max-height: 34vh; }
    #nyxScroll{ padding: 10px; }
    #nyxDockHeader{ padding: 10px; }
  }

  @media (prefers-reduced-motion: reduce){
    #nyxHeroVideo{ display:none !important; }
    #nyxStage{ background-size: cover !important; }
  }
</style>
</head>

<body class="nyx-phase1">
  <div id="nyxApp">

    <!-- HERO (Sacred) -->
    <section id="nyxHero" aria-label="Nyx hero">
      <div id="nyxStage" aria-hidden="true">
        <video id="nyxHeroVideo" autoplay muted loop playsinline preload="auto"></video>
      </div>

      <div id="nyxTopControls">
        <button class="nyx-mini" id="nyxVoiceToggle" type="button" aria-label="Voice toggle">Voice: ON</button>
      </div>

      <div id="nyxBubble" role="status" aria-live="polite">
        <div id="nyxBubbleText">…</div>
      </div>
    </section>

    <!-- DOCK -->
    <aside id="nyxDock" aria-label="Nyx dock">
      <header id="nyxDockHeader">
        <div id="nyxTitle">
          <span id="nyxDot" aria-hidden="true"></span>
          <span>Nyx</span>
          <span id="nyxMarion" title="Marion guiding" aria-label="Marion guiding">M</span>
        </div>
        <div id="nyxDockControls">
          <button class="nyx-btn" id="nyxExpand" type="button">Expand</button>
        </div>
      </header>

      <div id="nyxChips" aria-label="Modes">
        <button class="chip is-active" type="button" data-chip="general">General</button>
        <button class="chip" type="button" data-chip="music">Music</button>
        <button class="chip" type="button" data-chip="roku">Roku</button>
        <button class="chip" type="button" data-chip="movies">Movies</button>
        <button class="chip" type="button" data-chip="radio">Radio</button>
      </div>

      <div id="nyxScroll">
        <div id="nyxEmpty">No messages yet. Pick a mode above, or type below.</div>
        <div id="nyxMsgs" aria-label="Conversation"></div>
      </div>

      <footer id="nyxInputRow">
        <input id="nyxInput" type="text" placeholder="Type to Nyx…" autocomplete="off" />
        <button id="nyxSend" type="button">Send</button>
      </footer>
    </aside>

  </div>

<script>
(function(){
  "use strict";

  /* ============================================================
     0) Legacy purge — if anything tries to mount, delete it.
     (Fixes stray legacy close/X controls showing in the host.)
  ============================================================ */
  function purgeLegacy(){
    var kill = [
      "#wrap","#avatarRoot","#panel","#nyxOverlay","#nyxInputDock",
      "#sbnyx-host","#sbnyx-launcher","#nyxLauncher","#nyx-host",
      ".sbnyx-launcher",".sbnyx-host",".nyx-mic-puck",".mic-puck",".floating-mic",".micOrb","#micOrb","#nyxMicOrb",
      ".sbnyx-close","#sbnyxClose",".nyx-legacy-close","#nyxLegacyClose"
    ];
    for(var i=0;i<kill.length;i++){
      var sel = kill[i];
      try{
        var nodes = document.querySelectorAll(sel);
        for(var j=0;j<nodes.length;j++){
          var el = nodes[j];
          if(!el.closest || !el.closest("#nyxApp")) el.remove();
        }
      }catch(_){}
    }
  }
  purgeLegacy();
  window.addEventListener("load", purgeLegacy);
  try{
    var mo = new MutationObserver(function(){ purgeLegacy(); });
    mo.observe(document.documentElement, { childList:true, subtree:true });
  }catch(_){}

  /* ============================================================
     1) Helpers
  ============================================================ */
  function $(id){ return document.getElementById(id); }
  function safeStr(x, maxLen){
    var s = (x===null || x===undefined) ? "" : String(x);
    if(maxLen && isFinite(maxLen) && maxLen>0 && s.length>maxLen) s = s.slice(0, maxLen);
    return s;
  }
  function safeJsonParse(str){ try { return JSON.parse(str); } catch(e){ return null; } }
  function now(){ return Date.now(); }
  function makeId(){
    try{ if(window.crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(_){}
    return (Math.random().toString(16).slice(2) + now().toString(16)).slice(0, 24);
  }
  function clampToken(s, minLen){
    s = safeStr(s).trim();
    if(!s) return "";
    if(minLen && s.length < minLen) return "";
    if(s.length > 256) s = s.slice(0,256);
    return s;
  }
  function safeCssUrl(raw){
    var s = safeStr(raw).trim();
    if(!s) return "";
    if(!/^https?:\/\//i.test(s)) return "";
    s = s.replace(/[\r\n\t]/g, "");
    return s;
  }
  function isMp4Url(u){
    u = safeStr(u).toLowerCase();
    return (u.indexOf(".mp4") > -1) || (u.indexOf("video/mp4") > -1);
  }

  /* ============================================================
     2) Config (query bootstrap + postMessage override)
  ============================================================ */
  var CONFIG = {
    version: "PHASE1_CLEAN_v9204d",
    context: "sandblast",
    apiBase: null,
    token: null,
    chatPath: "/api/chat",
    heroSrc: null,
    voiceDefaultOn: false,
    publicMode: true
  };

  function parseQuery(){
    var out = {};
    try{
      var qs = (location.search || "").replace(/^\?/,"");
      if(!qs) return out;
      qs.split("&").forEach(function(kv){
        if(!kv) return;
        var p = kv.split("=");
        var k = decodeURIComponent(p[0]||"").trim();
        var v = decodeURIComponent((p[1]||"").replace(/\+/g," ")).trim();
        if(k) out[k]=v;
      });
    }catch(_){}
    return out;
  }

  function applyConfigPartial(part){
    if(!part || typeof part !== "object") return;
    if(typeof part.apiBase === "string" && part.apiBase.trim()) CONFIG.apiBase = part.apiBase.trim().replace(/\/+$/,"");
    if(typeof part.token === "string") CONFIG.token = clampToken(part.token, 16);
    if(typeof part.chatPath === "string" && part.chatPath.trim()) CONFIG.chatPath = part.chatPath.trim();
    if(typeof part.heroSrc === "string" && part.heroSrc.trim()) CONFIG.heroSrc = part.heroSrc.trim();
    if(typeof part.context === "string" && part.context.trim()) CONFIG.context = part.context.trim();
    if(typeof part.voiceDefaultOn === "boolean") CONFIG.voiceDefaultOn = part.voiceDefaultOn;
    if(typeof part.publicMode === "boolean") CONFIG.publicMode = part.publicMode;
  }

  (function bootstrapFromQuery(){
    var q = parseQuery();
    applyConfigPartial({
      apiBase: q.apiBase || q.API_BASE || q.base || q.backend,
      token: q.token || q.TOKEN || q.sbToken || q.sbt,
      heroSrc: q.heroSrc || q.hero || q.hero_url,
      chatPath: q.chatPath || q.chat || q.endpoint,
      context: q.context || q.ctx || q.mode,
      voiceDefaultOn: (q.voice !== undefined && q.voice !== "") ? /^(1|true|yes|on)$/i.test(String(q.voice)) : undefined,
      publicMode: (q.publicMode !== undefined && q.publicMode !== "") ? !/^(0|false|no|off)$/i.test(String(q.publicMode)) : undefined
    });
  })();

  /* ============================================================
     3) postMessage bridge (origin-learn + config)
  ============================================================ */
  var PARENT_ORIGIN = null;

  function postToParent(payload, allowWildcard){
    if(!window.parent || window.parent === window) return false;
    try{
      var target = PARENT_ORIGIN || (allowWildcard ? "*" : null);
      if(!target) return false;
      window.parent.postMessage(payload, target);
      return true;
    }catch(_){ return false; }
  }

  function sendReady(){ postToParent({ type:"NYX_READY", v: CONFIG.version, ts: now() }, true); }
  sendReady();
  var tries=0, maxTries=14;
  var tmr = setInterval(function(){
    tries++;
    if(tries>maxTries){ clearInterval(tmr); return; }
    sendReady();
  }, 250);

  window.addEventListener("message", function(ev){
    try{
      var data = ev && ev.data;
      if(typeof data === "string"){ var p = safeJsonParse(data); if(p) data = p; }
      if(!data || typeof data !== "object") return;
      if(typeof data.type !== "string" || data.type.indexOf("NYX_") !== 0) return;

      if(!PARENT_ORIGIN && ev.origin){ PARENT_ORIGIN = ev.origin; }
      if(PARENT_ORIGIN && ev.origin !== PARENT_ORIGIN) return;

      if(data.type === "NYX_CONFIG"){
        applyConfigPartial(data.config || {});
        applyHero(CONFIG.heroSrc);
        if(lsGet(VOICE_PREF_SET_KEY) !== "1"){
          setVoice(!!CONFIG.voiceDefaultOn);
        }
        postToParent({ type:"NYX_CONFIG_ACK", v: CONFIG.version, ts: now() }, false);
      }

      if(data.type === "NYX_SET_BUBBLE" && typeof data.text === "string"){
        setHeroBubble(data.text);
      }
    }catch(_){}
  });

  /* ============================================================
     4) Hero stage (video-first with image fallback)
  ============================================================ */
  var stageEl = $("nyxStage");
  var heroVid = $("nyxHeroVideo");

  function setStageImage(url){
    if(!stageEl) return;
    var u = safeCssUrl(url);
    if(!u) return;
    stageEl.style.backgroundImage = 'url("' + u + '")';
  }
  function setStageImageFallback(on){
    if(!stageEl) return;
    stageEl.classList.toggle("is-image", !!on);
  }
  function setHeroVideoSrc(url){
    if(!heroVid) return false;
    var u = safeCssUrl(url);
    if(!u) return false;

    try{
      heroVid.pause();
      heroVid.removeAttribute("src");
      while(heroVid.firstChild) heroVid.removeChild(heroVid.firstChild);
    }catch(_){}

    var source = document.createElement("source");
    source.src = u;
    source.type = "video/mp4";
    heroVid.appendChild(source);

    try{ heroVid.load(); }catch(_){}
    try{
      var p = heroVid.play();
      if(p && typeof p.catch === "function"){ p.catch(function(){}); }
    }catch(_){}
    return true;
  }

  function applyHero(heroSrc){
    var cssVid = "", cssImg = "", cssAbs = "";
    try{
      cssVid = getComputedStyle(document.documentElement).getPropertyValue("--nyx-hero-video").replace(/["']/g,"").trim();
      cssImg = getComputedStyle(document.documentElement).getPropertyValue("--nyx-hero-img-url").replace(/["']/g,"").trim();
      cssAbs = getComputedStyle(document.documentElement).getPropertyValue("--nyx-hero-abs").replace(/["']/g,"").trim();
    }catch(_){}

    var src = safeStr(heroSrc).trim() || cssVid || cssImg || cssAbs;
    src = safeCssUrl(src);

    if(cssImg) setStageImage(cssImg);
    else if(cssAbs) setStageImage(cssAbs);

    if(!src){
      setStageImageFallback(true);
      return;
    }

    if(isMp4Url(src)){
      setStageImageFallback(false);
      var ok = setHeroVideoSrc(src);
      if(!ok){
        setStageImage(src);
        setStageImageFallback(true);
      }
    }else{
      setStageImage(src);
      setStageImageFallback(true);
    }
  }

  if(heroVid){
    heroVid.muted = true;
    heroVid.loop = true;
    heroVid.playsInline = true;
    heroVid.setAttribute("playsinline","playsinline");
    heroVid.setAttribute("muted","muted");
    heroVid.setAttribute("autoplay","autoplay");
    setTimeout(function(){
      try{ if(heroVid.readyState < 2){ setStageImageFallback(true); } }catch(_){}
    }, 900);
    heroVid.addEventListener("error", function(){ setStageImageFallback(true); });
    heroVid.addEventListener("loadeddata", function(){ setStageImageFallback(false); });
  }
  applyHero(CONFIG.heroSrc);

  /* ============================================================
     5) Phase 1 Voice: toggle memory + autoplay-safe
     NOTE: Intro is ALWAYS text-only. Voice speaks replies only.
  ============================================================ */
  var voiceBtn = $("nyxVoiceToggle");
  var marionEl = $("nyxMarion");
  var expandBtn = $("nyxExpand");

  var VOICE_PREF_KEY = "nyx_voice_enabled_v1";
  var VOICE_PREF_SET_KEY = "nyx_voice_pref_set_v1";
  var INTRO_SHOWN_KEY = "nyx_intro_shown_v1";

  function lsGet(k){ try{ return localStorage.getItem(k); }catch(_){ return null; } }
  function lsSet(k,v){ try{ localStorage.setItem(k,v); }catch(_){ } }
  function ssGet(k){ try{ return sessionStorage.getItem(k); }catch(_){ return null; } }
  function ssSet(k,v){ try{ sessionStorage.setItem(k,v); }catch(_){ } }

  var UI = {
    voiceOn: true,
    audioUnlocked: false,
    expanded: false,
    lane: "general"
  };

  function readVoiceEnabled(){
    var prefSet = lsGet(VOICE_PREF_SET_KEY);
    if(!prefSet) return true; // default ON
    return lsGet(VOICE_PREF_KEY) !== "0";
  }
  function writeVoiceEnabled(on){
    lsSet(VOICE_PREF_SET_KEY, "1");
    lsSet(VOICE_PREF_KEY, on ? "1" : "0");
  }
  function setVoice(on){
    UI.voiceOn = !!on;
    writeVoiceEnabled(UI.voiceOn);
    if(voiceBtn){
      voiceBtn.classList.toggle("is-on", UI.voiceOn);
      voiceBtn.textContent = UI.voiceOn ? "Voice: ON" : "Voice: OFF";
    }
    if(!UI.voiceOn){
      stopAudio();
    }
  }

  function normalizeContext(ctx){
    var s = safeStr(ctx).toLowerCase();
    if(s.indexOf("roku")>-1) return "roku";
    if(s.indexOf("radio")>-1) return "radio";
    if(s.indexOf("news")>-1) return "news";
    if(s.indexOf("cog")>-1 || s.indexOf("marion")>-1) return "cognitive";
    return "sandblast";
  }
  function dayPart(){
    var h = 12;
    try{ h = (new Date()).getHours(); }catch(_){}
    if(h>=5 && h<=11) return "morning";
    if(h>=12 && h<=16) return "afternoon";
    if(h>=17 && h<=21) return "evening";
    return "late";
  }
  function pickGreeting(ctx, part){
    var t = {
      sandblast:{
        morning: "Good morning. I’m Nyx. Welcome to Sandblast. Where shall we begin?",
        afternoon: "Welcome. I’m Nyx. Tell me what you want to build today.",
        evening: "Evening. I’m Nyx. Let’s keep this sharp—what’s the target?",
        late: "Late hours. I’m Nyx. If we’re here now, it’s for a reason—what’s the goal?"
      },
      radio:{
        morning: "Morning. I’m Nyx—ready for radio mode?",
        afternoon: "I’m Nyx. Give me the vibe—then I’ll shape the set.",
        evening: "Evening. I’m Nyx. Cinematic or clean energy?",
        late: "Late-night mode. I’m Nyx. Give me the mood."
      },
      roku:{
        morning: "Good morning. I’m Nyx. Classics, serials, or a spotlight?",
        afternoon: "I’m Nyx. Tell me what row we’re building first.",
        evening: "Evening. I’m Nyx. What should the audience feel?",
        late: "Late hours. I’m Nyx. Let’s tighten the platform."
      },
      news:{
        morning: "Good morning. I’m Nyx. News, analysis, or both?",
        afternoon: "I’m Nyx. What topic should I prioritize today?",
        evening: "Evening. I’m Nyx. Fast brief or deep dive?",
        late: "Late hours. I’m Nyx. What are we investigating?"
      },
      cognitive:{
        morning: "Morning. I’m Nyx. We can go deep—pick a lane.",
        afternoon: "I’m Nyx. Tell me what you’re solving—then we’ll structure it.",
        evening: "Evening. I’m Nyx. Give me the objective—clean and direct.",
        late: "Late hours. I’m Nyx. Speak the goal. I’ll handle the structure."
      }
    };
    var table = t[ctx] || t.sandblast;
    return table[part] || table.afternoon;
  }

  function setHeroBubble(text){
    var el = $("nyxBubbleText");
    if(el) el.textContent = safeStr(text, 520);
  }

  // Audio playback (server TTS: /api/tts). Falls back to no-voice if unavailable.
  function stopAudio(){
    try{
      if(window.__NYX_AUDIO && typeof window.__NYX_AUDIO.pause === "function"){
        window.__NYX_AUDIO.pause();
        window.__NYX_AUDIO.currentTime = 0;
      }
    }catch(_){}
  }

  async function speak(text){
    if(!UI.voiceOn) return { ok:false, reason:"voice_off" };
    if(!UI.audioUnlocked) return { ok:false, reason:"locked" };

    var s = safeStr(text).trim();
    if(!s) return { ok:false, reason:"empty" };

    stopAudio();

    var base = (CONFIG.apiBase && CONFIG.apiBase.trim()) ? CONFIG.apiBase.trim().replace(/\/+$/,"") : location.origin;
    var url = base + "/api/tts";

    var headers = { "Content-Type":"application/json" };
    if(CONFIG.token){
      headers["x-sb-token"] = CONFIG.token;
      headers["Authorization"] = "Bearer " + CONFIG.token;
      headers["X-API-Token"] = CONFIG.token;
    }

    var ctrl = new AbortController();
    var to = setTimeout(function(){ try{ ctrl.abort(); }catch(_){} }, 12000);

    try{
      var r = await fetch(url, {
        method:"POST",
        headers: headers,
        body: JSON.stringify({ text: s }),
        signal: ctrl.signal
      });

      if(!r.ok) return { ok:false, reason:"tts_http_"+r.status };

      var blob = await r.blob();
      if(!blob || !blob.size) return { ok:false, reason:"tts_empty" };

      var audio = new Audio();
      audio.src = URL.createObjectURL(blob);
      audio.preload = "auto";
      window.__NYX_AUDIO = audio;

      var p = audio.play();
      if(p && typeof p.catch === "function"){
        await p.catch(function(){ throw new Error("autoplay_blocked"); });
      }
      return { ok:true };
    } catch(e){
      return { ok:false, reason:(e && e.message) ? e.message : "tts_fail" };
    } finally {
      clearTimeout(to);
    }
  }

  // Wire voice toggle
  if(voiceBtn){
    voiceBtn.addEventListener("click", function(){
      UI.audioUnlocked = true;         // explicit user gesture => unlock audio
      setVoice(!UI.voiceOn);
    });
  }

  // Set initial voice state (button text is updated here)
  setVoice(readVoiceEnabled());

  /* ============================================================
     6) Chat client (clean)
  ============================================================ */
  var dockEl = $("nyxDock");
  var emptyEl = $("nyxEmpty");
  var msgsEl = $("nyxMsgs");
  var inputEl = $("nyxInput");
  var sendBtn = $("nyxSend");
  var chipsEl = $("nyxChips");

  var THREAD = [];
  var MAX_TURNS = 20;

  function updateEmptyState(){
    if(!dockEl) return;
    dockEl.classList.toggle("is-empty", THREAD.length === 0);
  }

  function pushMsg(role, text){
    text = safeStr(text).trim();
    if(!text) return;
    THREAD.push({ role: role, text: text, ts: now() });
    if(THREAD.length > MAX_TURNS) THREAD = THREAD.slice(THREAD.length - MAX_TURNS);
    updateEmptyState();
  }

  function renderMsgs(){
    if(!msgsEl) return;
    msgsEl.innerHTML = "";
    for(var i=0;i<THREAD.length;i++){
      var m = THREAD[i];
      var div = document.createElement("div");
      div.className = "nyx-msg" + (m.role === "user" ? " me" : "");
      div.textContent = m.text;
      msgsEl.appendChild(div);
    }
    try{
      var sc = $("nyxScroll");
      if(sc) sc.scrollTop = sc.scrollHeight;
    }catch(_){}
  }

  function setMarionOn(on){
    if(!marionEl) return;
    marionEl.classList.toggle("on", !!on);
  }

  function setActiveChip(chip){
    UI.lane = safeStr(chip).toLowerCase().trim() || "general";
    if(chipsEl){
      var list = chipsEl.querySelectorAll(".chip");
      for(var i=0;i<list.length;i++){
        var el = list[i];
        el.classList.toggle("is-active", el.getAttribute("data-chip") === UI.lane);
      }
    }
  }
  setActiveChip("general");

  function apiBase(){
    var b = (CONFIG.apiBase && String(CONFIG.apiBase).trim()) ? String(CONFIG.apiBase).trim() : location.origin;
    return b.replace(/\/+$/,"");
  }

  async function postJson(url, payload, timeoutMs){
    timeoutMs = timeoutMs || 12000;
    var headers = { "Content-Type":"application/json" };
    if(CONFIG.token){
      headers["x-sb-token"] = CONFIG.token;
      headers["Authorization"] = "Bearer " + CONFIG.token;
      headers["X-API-Token"] = CONFIG.token;
    }

    var ctrl = new AbortController();
    var to = setTimeout(function(){ try{ ctrl.abort(); }catch(_){} }, timeoutMs);

    try{
      var r = await fetch(url, {
        method:"POST",
        headers: headers,
        body: JSON.stringify(payload),
        credentials: "include",
        signal: ctrl.signal
      });
      var txt = await r.text().catch(function(){ return ""; });
      var json = safeJsonParse(txt);
      if(!json) return { ok:false, error:"bad_json", status:r.status, raw: txt.slice(0, 500) };
      json.__httpStatus = r.status;
      return json;
    } catch(e){
      return { ok:false, error:(e && e.name === "AbortError") ? "timeout" : "network", status:0 };
    } finally {
      clearTimeout(to);
    }
  }

  async function sendText(text){
    text = safeStr(text).trim();
    if(!text) return;

    if(sendBtn) sendBtn.disabled = true;
    if(inputEl) inputEl.disabled = true;

    pushMsg("user", text);
    renderMsgs();

    var url = apiBase() + (CONFIG.chatPath || "/api/chat");
    var packet = {
      requestId: makeId(),
      text: text,
      lane: UI.lane,
      ctx: {
        tail: THREAD.slice(-8).map(function(m){ return { r:m.role, t:safeStr(m.text,360) }; }),
        source: "nyx_host_phase1_clean",
        context: safeStr(CONFIG.context, 40)
      },
      client: { source:"nyx_host_iframe", lane:UI.lane }
    };

    postToParent({ type:"NYX_USER_TEXT", text:text, lane:UI.lane, ts:now() }, false);

    var res = await postJson(url, packet, 14000);

    var reply = "";
    if(res){
      reply = safeStr(res.reply || res.text || (res.data && (res.data.reply || res.data.text)) || "");
    }
    if(!reply && res && res.ok === false && res.error){
      reply = "I hit a connection issue. If you're running a demo, pass apiBase/token in NYX_CONFIG so I can talk to the backend.";
    }
    if(!reply) reply = "…";

    if(res && res.lane && typeof res.lane === "string"){
      setActiveChip(res.lane.toLowerCase());
    }
    if(res && typeof res.marionOn === "boolean") setMarionOn(res.marionOn);
    if(res && res.cog && typeof res.cog === "object"){
      postToParent({ type:"NYX_COG", lane: UI.lane, cog: res.cog, ts: now() }, false);
    }

    pushMsg("nyx", reply);
    renderMsgs();
    setHeroBubble(reply);

    if(UI.voiceOn && UI.audioUnlocked){
      var short = reply.length > 220 ? (reply.slice(0,220) + "…") : reply;
      speak(short).catch(function(){});
    }

    if(sendBtn) sendBtn.disabled = false;
    if(inputEl) inputEl.disabled = false;
    if(inputEl) inputEl.focus();
  }

  if(sendBtn){
    sendBtn.addEventListener("click", function(){
      var v = inputEl ? inputEl.value : "";
      if(inputEl) inputEl.value = "";
      sendText(v);
    });
  }
  if(inputEl){
    inputEl.addEventListener("keydown", function(e){
      if(e.key === "Enter"){
        e.preventDefault();
        var v = inputEl.value;
        inputEl.value = "";
        sendText(v);
      }
    });
  }

  if(chipsEl){
    chipsEl.addEventListener("click", function(e){
      var t = e.target;
      while(t && t !== chipsEl && !(t.classList && t.classList.contains("chip"))){
        t = t.parentNode;
      }
      if(!t || t === chipsEl) return;
      var chip = t.getAttribute("data-chip");
      if(!chip) return;
      setActiveChip(chip);

      // No empty "send"; we simply reflect lane + inform parent.
      setHeroBubble("Mode: " + UI.lane.toUpperCase());
      postToParent({ type:"NYX_CHIP", chip: UI.lane, lane: UI.lane, ts: now() }, false);

      // Optional: if backend supports a "lane_select" event, it can be handled; safe if ignored.
      try{
        var url = apiBase() + (CONFIG.chatPath || "/api/chat");
        postJson(url, { requestId: makeId(), type:"lane_select", lane: UI.lane, ctx:{ source:"nyx_host_phase1_clean" } }, 6000).catch(function(){});
      }catch(_){}
    });
  }

  // Expand: focus dock transcript; hides hero bubble
  if(expandBtn){
    expandBtn.addEventListener("click", function(){
      UI.expanded = !UI.expanded;
      expandBtn.textContent = UI.expanded ? "Collapse" : "Expand";
      var b = $("nyxBubble");
      if(b) b.style.display = UI.expanded ? "none" : "";
      if(inputEl) inputEl.focus();
    });
  }

  function maybeRunIntro(){
    var ctx = normalizeContext(CONFIG.context);
    var part = dayPart();
    var line = pickGreeting(ctx, part);

    if (ssGet(INTRO_SHOWN_KEY) !== "1"){
      setHeroBubble(line);
      pushMsg("nyx", line);
      renderMsgs();
      ssSet(INTRO_SHOWN_KEY, "1");
    }
  }

  // First paint: intro text only; keep voice conservative
  setTimeout(function(){
    maybeRunIntro();
    updateEmptyState();
    if(inputEl) inputEl.focus();
    var bt = $("nyxBubbleText");
    if(bt && (!bt.textContent || bt.textContent.trim() === "…")){
      setHeroBubble("Hi. I’m Nyx.");
    }
  }, 450);

})();
</script>
</body>
</html>
