"use strict";

/**
 * Scripts/build_top10_by_year_1950_2025.js
 *
 * FIX++++:
 *  - Strips placeholder rows ("Title" / "Artist(s)")
 *  - Re-normalizes pos after cleanup
 *  - Guarantees clean Top 10 per year
 *
 * Source:
 *  - Wikipedia per-year cache (Data/wikipedia/charts)
 */

const fs = require("fs");
const path = require("path");

const DATA_DIR = path.resolve(__dirname, "..", "Data");
const WIKI_DIR = path.join(DATA_DIR, "wikipedia", "charts");
const OUT_FILE = path.join(DATA_DIR, "top10_by_year_v1.json");

const YEAR_START = 1950;
const YEAR_END = 2025;

function isGarbageRow(row) {
  if (!row) return true;
  const t = String(row.title || "").trim();
  const a = String(row.artist || "").trim();
  return (
    !t ||
    !a ||
    t.toLowerCase() === "title" ||
    a.toLowerCase() === "artist(s)"
  );
}

function normalizeRows(rows) {
  return rows
    .filter(r => !isGarbageRow(r))
    .slice(0, 10)
    .map((r, idx) => ({
      pos: idx + 1,
      title: String(r.title).trim(),
      artist: String(r.artist).trim(),
      sourcePos: r.sourcePos ?? r.pos ?? null
    }));
}

function loadYearFile(year) {
  const file = path.join(WIKI_DIR, `${year}.json`);
  if (!fs.existsSync(file)) return null;
  try {
    return JSON.parse(fs.readFileSync(file, "utf8"));
  } catch {
    return null;
  }
}

const output = {
  version: "top10_by_year_v1",
  chart: "Billboard Year-End Hot 100",
  source: "Wikipedia per-year cache (Data/wikipedia/charts)",
  generatedAt: new Date().toISOString(),
  meta: {
    yearStart: YEAR_START,
    yearEnd: YEAR_END,
    wikiDir: "Data/wikipedia/charts",
    weakYears: [],
    missingYears: []
  },
  years: {}
};

for (let year = YEAR_START; year <= YEAR_END; year++) {
  const data = loadYearFile(year);
  if (!data || !Array.isArray(data.items)) {
    output.meta.missingYears.push(year);
    continue;
  }

  const clean = normalizeRows(data.items);

  if (clean.length < 10) {
    output.meta.weakYears.push(year);
  }

  output.years[String(year)] = {
    year,
    chart: "Billboard Year-End Hot 100 (Wikipedia cache)",
    items: clean
  };
}

fs.writeFileSync(OUT_FILE, JSON.stringify(output, null, 2));
console.log(
  `✔ Top10 build complete (${YEAR_START}–${YEAR_END}) → ${path.basename(OUT_FILE)}`
);
