"use strict";

/**
 * Scripts/pull_wiki_yearend_hot100_1950_2025.js
 *
 * Fetch Wikipedia Billboard year-end pages and write normalized JSON:
 *   Data/wikipedia/charts/year_end_hot100_<YEAR>.json
 *
 * Output shape:
 *   { year, chart, sourceUrl, rows: [{ pos, title, artist }] }
 *
 * Usage:
 *   node Scripts/pull_wiki_yearend_hot100_1950_2025.js
 */

const fs = require("fs");
const path = require("path");
const https = require("https");

const OUT_DIR = path.resolve(__dirname, "..", "Data", "wikipedia", "charts");
fs.mkdirSync(OUT_DIR, { recursive: true });

const CHART_LABEL = "Billboard Year-End (Wikipedia)";

// ---- paste your URL lists here (or keep as-is) ----
const URLS = [
  // 1950–1955 top 30
  "https://en.wikipedia.org/wiki/Billboard_year-end_top_30_singles_of_1950",
  "https://en.wikipedia.org/wiki/Billboard_year-end_top_30_singles_of_1951",
  "https://en.wikipedia.org/wiki/Billboard_year-end_top_30_singles_of_1952",
  "https://en.wikipedia.org/wiki/Billboard_year-end_top_30_singles_of_1953",
  "https://en.wikipedia.org/wiki/Billboard_year-end_top_30_singles_of_1954",
  "https://en.wikipedia.org/wiki/Billboard_year-end_top_30_singles_of_1955",

  // 1956–1958 top 50
  "https://en.wikipedia.org/wiki/Billboard_year-end_top_50_singles_of_1956",
  "https://en.wikipedia.org/wiki/Billboard_year-end_top_50_singles_of_1957",
  "https://en.wikipedia.org/wiki/Billboard_year-end_top_50_singles_of_1958",

  // 1959–2025 Hot 100
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1959",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1960",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1961",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1962",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1963",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1964",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1965",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1966",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1967",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1968",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1969",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1970",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1971",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1972",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1973",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1974",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1975",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1976",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1977",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1978",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1979",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1980",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1981",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1982",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1983",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1984",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1985",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1986",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1987",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1988",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1989",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1990",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1991",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1992",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1993",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1994",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1995",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1996",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1997",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1998",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_1999",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2000",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2001",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2002",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2003",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2004",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2005",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2006",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2007",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2008",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2009",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2010",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2011",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2012",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2013",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2014",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2015",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2016",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2017",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2018",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2019",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2020",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2021",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2022",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2023",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2024",
  "https://en.wikipedia.org/wiki/Billboard_Year-End_Hot_100_singles_of_2025",
];

function fetch(url) {
  return new Promise((resolve, reject) => {
    https
      .get(
        url,
        {
          headers: {
            "User-Agent":
              "SandblastBot/1.0 (https://sandblastchannel.com) node-fetch-like",
            Accept: "text/html",
          },
        },
        (res) => {
          if (res.statusCode !== 200) {
            reject(new Error(`HTTP ${res.statusCode} for ${url}`));
            res.resume();
            return;
          }
          res.setEncoding("utf8");
          let data = "";
          res.on("data", (chunk) => (data += chunk));
          res.on("end", () => resolve(data));
        }
      )
      .on("error", reject);
  });
}

function extractYear(url) {
  const m = url.match(/_of_(\d{4})$/);
  if (!m) throw new Error(`Could not parse year from URL: ${url}`);
  return parseInt(m[1], 10);
}

// Minimal HTML table parser for Wikipedia wikitable rows.
// We intentionally avoid dependencies here.
function stripTags(s) {
  return (s || "")
    .replace(/<sup[^>]*>.*?<\/sup>/gi, "")
    .replace(/<\/?[^>]+>/g, "")
    .replace(/&nbsp;/g, " ")
    .replace(/&amp;/g, "&")
    .replace(/&quot;/g, '"')
    .replace(/&#39;/g, "'")
    .replace(/&lt;/g, "<")
    .replace(/&gt;/g, ">")
    .replace(/\s+/g, " ")
    .trim();
}

function findFirstWikiTable(html) {
  const idx = html.search(/class="[^"]*\bwikitable\b[^"]*"/i);
  if (idx < 0) return null;

  // Back up to <table ...>
  const start = html.lastIndexOf("<table", idx);
  if (start < 0) return null;

  // Forward to </table>
  const end = html.indexOf("</table>", idx);
  if (end < 0) return null;

  return html.slice(start, end + "</table>".length);
}

function extractRowsFromTable(tableHtml) {
  // Split by <tr> ... </tr>
  const trs = tableHtml.split(/<\/tr>/i);
  const rows = [];

  for (const trChunk of trs) {
    const tr = trChunk;
    if (!/<t[dh][^>]*>/i.test(tr)) continue;

    // Grab <td> and <th> cells in order
    const cells = [];
    const cellRe = /<(t[dh])\b[^>]*>([\s\S]*?)<\/\1>/gi;
    let m;
    while ((m = cellRe.exec(tr))) {
      cells.push(stripTags(m[2]));
    }
    if (cells.length < 2) continue;

    rows.push(cells);
  }
  return rows;
}

function guessColumns(cells) {
  // Typical: [No., Title, Artist] or [No., Single, Artist(s)]
  // We will treat first as rank, then try to pick title/artist from remaining.
  const pos = parseInt((cells[0] || "").replace(/[^\d]/g, ""), 10);
  const title = cells[1] || "";
  const artist = cells[2] || cells[1] || "";
  return { pos: Number.isFinite(pos) ? pos : null, title, artist };
}

async function run() {
  let ok = 0;
  let fail = 0;

  for (const url of URLS) {
    const year = extractYear(url);
    const outFile = path.join(OUT_DIR, `year_end_hot100_${year}.json`);

    try {
      const html = await fetch(url);
      const table = findFirstWikiTable(html);
      if (!table) throw new Error("No wikitable found");

      const rawRows = extractRowsFromTable(table);

      // drop header-ish rows (where first cell isn't numeric)
      const rows = rawRows
        .map((cells) => guessColumns(cells))
        .filter((r) => r.title && r.artist);

      // If rank parsing failed (early tables sometimes), assign sequential if we have many.
      let normalized = rows;
      const ranklessCount = rows.filter((r) => !r.pos).length;
      if (ranklessCount > 0 && rows.length >= 10) {
        normalized = rows.map((r, i) => ({ ...r, pos: r.pos || i + 1 }));
      }

      const payload = {
        year,
        chart: CHART_LABEL,
        sourceUrl: url,
        rows: normalized.map((r) => ({
          pos: r.pos,
          title: r.title,
          artist: r.artist,
        })),
      };

      fs.writeFileSync(outFile, JSON.stringify(payload, null, 2), "utf8");
      // eslint-disable-next-line no-console
      console.log(`✅ ${year} -> ${path.relative(process.cwd(), outFile)} (${payload.rows.length} rows)`);
      ok++;
    } catch (e) {
      // eslint-disable-next-line no-console
      console.error(`❌ ${year} ${url}\n   ${e.message}`);
      fail++;
    }
  }

  // eslint-disable-next-line no-console
  console.log(`\nDone. OK=${ok} FAIL=${fail}`);
  if (fail) process.exitCode = 1;
}

run().catch((e) => {
  // eslint-disable-next-line no-console
  console.error(e);
  process.exitCode = 1;
});
